{% extends "base_site.html" %}
{% load humanize %}
{% block body_class %}sj-page-financeiro{% endblock %}
{% block content %}
<div class="sj-wrap" style="max-width:980px;margin:18px auto;padding:0 12px;">

  <div class="sj-card" style="
      background:rgba(10,16,28,.88);
      border:1px solid rgba(47,191,113,.22);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      overflow:hidden;
  ">
    <div style="
        padding:14px 16px;
        background:linear-gradient(135deg,#1f7a3a,#2fbf71);
        color:#fff;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
    ">
      <div>
        <div style="font-weight:800;font-size:1.05rem;line-height:1.1;">üßæ Vendas com Override de Lote</div>
        <div style="opacity:.9;font-size:.9rem;">(vendas que tiveram justificativa de lote vencido)</div>
      </div>

      <a href="/pdv/" style="
          text-decoration:none;
          color:#fff;
          font-weight:700;
          padding:8px 12px;
          border-radius:999px;
          border:1px solid rgba(255,255,255,.25);
          background:rgba(255,255,255,.12);
          white-space:nowrap;
      ">
        ‚Üê Voltar ao PDV
      </a>
    </div>
    <!-- ‚úÖ Resumo do topo (Overrides) -->
    <div style="padding:14px 16px;color:#e8f0ff;">
      <div style="display:grid; grid-template-columns:repeat(4, minmax(160px, 1fr)); gap:12px; margin-bottom:12px;">

        <div
          style="background:rgba(10,16,28,.85); border:1px solid rgba(255,99,99,.25); border-radius:16px; padding:12px;">
          <div style="opacity:.8; font-size:.85rem;">Overrides</div>
          <div id="cardOverrides" style="font-size:1.35rem; font-weight:900;">0</div>
          <div style="opacity:.75; font-size:.85rem;">vendas com justificativa</div>
        </div>

        <div
          style="background:rgba(10,16,28,.85); border:1px solid rgba(47,191,113,.25); border-radius:16px; padding:12px;">
          <div style="opacity:.8; font-size:.85rem;">Valor envolvido</div>
          <div style="font-size:1.35rem; font-weight:900;">
            <span id="cardValor">R$ 0,00</span>
          </div>

          <div style="opacity:.75; font-size:.85rem;">total em overrides</div>
        </div>

        <div
          style="background:rgba(10,16,28,.85); border:1px solid rgba(255,193,7,.25); border-radius:16px; padding:12px;">
          <div style="opacity:.8; font-size:.85rem;">Produto mais afetado</div>
          <div id="cardProduto" style="font-size:1.05rem; font-weight:900; line-height:1.2;">-</div>
          <div id="cardProdutoQtd" style="opacity:.75; font-size:.85rem;">0 item(ns)</div>
        </div>

        <div
          style="background:rgba(10,16,28,.85); border:1px solid rgba(110,168,254,.25); border-radius:16px; padding:12px;">
          <div style="opacity:.8; font-size:.85rem;">Operador</div>
          <div id="cardOperador" style="font-size:1.05rem; font-weight:900; line-height:1.2;">-</div>
          <div id="cardOperadorQtd" style="opacity:.75; font-size:.85rem;">0 venda(s)</div>

        </div>

      </div>
    </div>

    <!-- ‚úÖ Tabela de vendas com override -->

    <div style="padding:14px 16px;color:#e8f0ff;">
      {% if vendas %}
      <div style="overflow:auto;">
        <table style="width:100%;border-collapse:collapse;min-width:760px;">
          <thead>
            <tr style="text-align:left;font-size:.85rem;opacity:.85;">
              <th style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.10);">Venda</th>
              <th style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.10);">Data</th>
              <th style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.10);">Operador</th>
              <th style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.10);">Forma</th>
              <th style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.10);text-align:right;">Total</th>
              <th style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.10);">Justificativa</th>
            </tr>
          </thead>
          <tbody>
            {% for v in vendas %}
            <tr style="vertical-align:top;">
              <td style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);">
                <span style="
                      display:inline-block;
                      padding:6px 10px;
                      border-radius:999px;
                      border:1px solid rgba(255,107,107,.25);
                      background:rgba(255,107,107,.10);
                      color:#ff8b8b;
                      font-weight:800;
                  ">
                  #{{ v.id }}
                </span>
              </td>

              <td style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);opacity:.9;">
                {{ v.criado_em|date:"d/m/Y H:i" }}
              </td>

              <td style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);opacity:.95;">
                {{ v.operador }}
              </td>

              <td style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);opacity:.9;">
                {{ v.get_forma_pagamento_display }}
              </td>

              <td
                style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:right;font-weight:800;">
                R$ {{ v.total|floatformat:2 }}
              </td>

              <td style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);">
                <div style="
                      border:1px solid rgba(255,255,255,.10);
                      background:rgba(255,255,255,.06);
                      border-radius:12px;
                      padding:8px 10px;
                      line-height:1.25;
                      white-space:pre-wrap;
                  ">
                  {{ v.justificativa_lote }}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div style="margin-top:10px;opacity:.75;font-size:.9rem;">
        Mostrando as √∫ltimas <strong>{{ vendas|length }}</strong> vendas com justificativa.
      </div>
      {% else %}
      <div id="bannerSemVendas"style="
            padding:14px 12px;
            border-radius:14px;
            border:1px solid rgba(255,255,255,.10);
            background:rgba(255,255,255,.06);
            opacity:.9;
        ">
        ‚úÖ Nenhuma venda com override/justificativa de lote encontrada.
      </div>
      {% endif %}
    </div>
  </div>

</div>
<script>
(function () {
  "use strict";

  const fmtBRL = (n) =>
  (Number(n) || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

async function carregarResumoOverrides() {
  const elOverrides = document.getElementById("cardOverrides");
  const elValor = document.getElementById("cardValor");
  const elProduto = document.getElementById("cardProduto");
  const elProdutoQtd = document.getElementById("cardProdutoQtd");
  const elOperador = document.getElementById("cardOperador");
  const elOperadorQtd = document.getElementById("cardOperadorQtd");
  const banner = document.getElementById("bannerSemVendas");

  try {
    const res = await fetch("/pdv/api/overrides/resumo/");
    const json = await res.json();
    if (!json.ok) return;

    // ‚úÖ agora json existe, ent√£o podemos usar
    if (banner && (json.total_overrides_30d ?? 0) > 0) {
      banner.style.display = "none";
    }

    if (elOverrides) elOverrides.textContent = json.total_overrides_30d ?? 0;

    const valor = json.valor_envolvido_30d ?? 0;
    if (elValor) elValor.textContent = fmtBRL(json.valor_envolvido_30d ?? 0);

    // ===============================
    // üö¶ Badge de risco (Valor envolvido)
    // ===============================
    const cardValorBox = elValor ? elValor.closest("div[style*='border:1px']") : null;

    // thresholds (ajuste se quiser)
    const T_AMARELO = 50;
    const T_VERMELHO = 200;

    let corBorda = "rgba(47,191,113,.35)";
    let corFundo = "rgba(47,191,113,.08)";
    let label = "OK";

    if (valor >= T_VERMELHO) {
      corBorda = "rgba(255,80,80,.65)";
      corFundo = "rgba(255,80,80,.10)";
      label = "A√á√ÉO IMEDIATA";
    } else if (valor >= T_AMARELO) {
      corBorda = "rgba(255,193,7,.55)";
      corFundo = "rgba(255,193,7,.10)";
      label = "ATEN√á√ÉO";
    }

    if (cardValorBox) {
      cardValorBox.style.borderColor = corBorda;
      cardValorBox.style.background = `linear-gradient(180deg, ${corFundo}, rgba(10,16,28,.85))`;
    }

    // cria/atualiza badge pequeno no card
    let badge = document.getElementById("badgeValorRisco");
    if (elValor) {
      if (!badge) {
        badge = document.createElement("span");
        badge.id = "badgeValorRisco";
        badge.style.display = "inline-block";
        badge.style.marginLeft = "10px";
        badge.style.padding = "4px 8px";
        badge.style.borderRadius = "999px";
        badge.style.fontSize = ".75rem";
        badge.style.fontWeight = "800";
        badge.style.verticalAlign = "middle";
        badge.style.border = "1px solid rgba(255,255,255,.14)";
        badge.style.background = "rgba(255,255,255,.06)";
        elValor.parentElement.appendChild(badge);
      }

      badge.textContent = label;
      badge.style.borderColor = corBorda;
      badge.style.color = label === "OK" ? "rgba(47,191,113,1)" : (label === "ATEN√á√ÉO" ? "rgba(255,193,7,1)" : "rgba(255,80,80,1)");
    }



    if (elProduto) elProduto.textContent = json.top_produto_nome_30d ?? "-";

    const qtdProd = json.top_produto_qtd_30d ?? 0;
    if (elProdutoQtd) elProdutoQtd.textContent = `${qtdProd} un.`;


        // Operador campe√£o (30 dias)
    if (elOperador) {
      elOperador.textContent = json.top_operador_nome_30d ?? "-";
    }

    if (elOperadorQtd) {
      elOperadorQtd.textContent = `${json.top_operador_qtd_30d ?? 0} venda(s)`;
    }

    // Produto mais afetado (30 dias)
    if (elProduto) {
      elProduto.textContent = json.top_produto_nome_30d ?? "-";
    }

    if (elProdutoQtd) {
      elProdutoQtd.textContent = `${json.top_produto_qtd_30d ?? 0} un.`;
    }

  } catch (e) {
    console.error("[Overrides] erro ao carregar resumo", e);
  }
}

document.addEventListener("DOMContentLoaded", carregarResumoOverrides);
})();
</script>

{% endblock %}