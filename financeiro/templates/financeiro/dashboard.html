{% extends "base_site.html" %}
{% load static moeda humanize %}

{% block title %}üìä Painel Financeiro ‚Äî TESTE{% endblock %}

{% block stylesheet %}
  <link rel="stylesheet" href="{% static 'financeiro/admin_override.css' %}">
  <link rel="stylesheet" href="{% static 'financeiro/style.css' %}">
{% endblock %}


{% block extrahead %}
  {{ block.super }}
  <meta name="csrf-token" content="{{ csrf_token }}"/>
{% endblock %}

{% block content %}
<!-- todo o painel aqui -->

<div class="container py-4">
  <div class="alert alert-success mb-3">
    Template OK ‚úî ‚Äî Bootstrap + <code>financeiro/style.css</code> carregados.
  </div>

  <button class="btn btn-success">Bot√£o Bootstrap</button>

  <div class="mt-3 p-3 border rounded" style="background:#f4fdf5;">
    <strong>Teste de CSS do painel:</strong>
    <div class="badge-tipo badge-positiva mt-2">
      <span class="badge-dot"></span> Positiva
    </div>
  </div>
</div>

<p style="opacity:.6">
  DEBUG: {{ total_receitas }} | {{ total_despesas }} | {{ saldo }}
</p>

<!-- üê∂ Badge Dev Spa√ßo da Jhus√©na -->
<div id="devBadge" class="alert alert-success py-1 px-2 mb-2 d-inline-flex align-items-center" style="font-size:.9rem; display:none;">
  <strong class="me-2">Dev mode</strong>
  <span id="devBadgeText">inicializando‚Ä¶</span>
</div>

<h2 class="mb-3">üìä Painel Financeiro Inteligente</h2>
<div class="alert alert-success">
  Se voc√™ est√° vendo esta mensagem, o template carregou certinho. ü§ù
</div>
<div class="d-flex justify-content-end mb-3">
  <button id="btnToggleTema" class="btn btn-outline-dark btn-sm" type="button">
    üåô Modo escuro
  </button>
</div>

<div id="boxResumoMensal" class="alert alert-info d-none"></div>

<script>
  const MESES = ["","Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const brl = new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});
  const num = (x)=> (typeof x==="number"? x : Number(x)||0);

  function getCsrfToken(){
    const m=document.querySelector('meta[name="csrf-token"]');
    if(m?.content) return m.content;
    const match=document.cookie.match(/(^|;)\s*csrftoken=([^;]+)/);
    return match? decodeURIComponent(match[2]) : "";
  }

  async function carregarResumoMensal(){
    const box=document.getElementById("boxResumoMensal");
    if(!box) return;
    try{
      const url=window.URL_RESUMO_MENSAL || "/financeiro/ia/resumo-mensal/";
      const r=await fetch(url,{headers:{"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const d=await r.json();
      const mes=Number(d.mes)||0;
      const ano=d.ano||"";
      const mesLabel=(mes>=1 && mes<=12)? `${MESES[mes]}/${ano}` : `${mes}/${ano}`;

      box.classList.remove("d-none","alert-warning");
      box.classList.add("alert-info");
      box.innerHTML = `
        <strong>üìÖ ${mesLabel}</strong><br>
        Receitas: ${brl.format(num(d.total_receitas))} |
        Despesas: ${brl.format(num(d.total_despesas))} |
        Saldo: ${brl.format(num(d.saldo))}
      `;
      if(d.dica){
        const dicaEl=document.createElement("div");
        dicaEl.textContent=`üí° ${d.dica}`;
        box.appendChild(dicaEl);
      }
      document.getElementById("placeholderInsights")?.classList.add("d-none");
      document.getElementById("placeholderInsightCard")?.classList.add("d-none");
    }catch(e){
      box.classList.remove("d-none","alert-info");
      box.classList.add("alert-warning");
      box.textContent="N√£o foi poss√≠vel carregar o resumo mensal agora.";
      console.error("Falha ao carregar resumo mensal:",e);
    }
  }
  document.addEventListener("DOMContentLoaded", carregarResumoMensal);
</script>

<!-- Totais -->
<div class="row g-3">
  <div class="col-md-4">
    <div class="card border-success">
      <div class="card-body">
        <div class="fw-semibold">Receitas</div>
        <div class="h4 text-success">{{ total_receitas|moeda }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-danger">
      <div class="card-body">
        <div class="fw-semibold">Despesas</div>
        <div class="h4 text-danger">{{ total_despesas|moeda }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-primary">
      <div class="card-body">
        <div class="fw-semibold">Saldo</div>
        <div class="h4 text-primary">{{ saldo|moeda }}</div>
      </div>
    </div>
  </div>
</div>

<!-- üí° Œ≤ Mini-IA -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card border-primary">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            üí° Recomenda√ß√µes Inteligentes
            <span class="badge bg-primary-subtle text-primary border border-primary ms-2">Œ≤ Mini-IA</span>
          </h5>
          <button id="btnTurbo" class="btn btn-primary btn-sm" type="button">
            ‚ö° Gerar dica dos √∫ltimos 30 dias
          </button>
        </div>
        <div id="turboStatus" class="small text-muted mt-2 d-none">Analisando‚Ä¶</div>

        <div id="turboResult" class="mt-3 d-none">
          <div class="alert alert-info mb-2" id="turboDica"></div>
          <details class="small">
            <summary>M√©tricas do per√≠odo</summary>
            <ul class="mb-0" id="turboMetrics"></ul>
          </details>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üß≠ Filtros Superiores -->
<div class="row g-2 align-items-end mb-2 mt-4">
  <div class="col-sm-3">
    <label class="form-label">In√≠cio</label>
    <input type="date" id="filtroInicio" class="form-control" />
  </div>
  <div class="col-sm-3">
    <label class="form-label">Fim</label>
    <input type="date" id="filtroFim" class="form-control" />
  </div>
  <div class="col-sm-3">
    <label for="filtroCategoria" class="form-label">Categoria</label>
    <select id="filtroCategoria" class="form-select">
      <option value="">Todas</option>
      <option value="Geral">Geral</option>
      <option value="Alerta">Alerta</option>
      <option value="Meta">Meta</option>
      <option value="Dica">Dica</option>
    </select>
  </div>
  <div class="col-sm-3 d-flex gap-2">
    <button id="btnAplicarFiltros" class="btn btn-success w-50" type="button">Aplicar</button>
    <button id="btnGerarDica" class="btn btn-outline-primary w-50" type="button">Gerar nova dica</button>
  </div>
</div>

<!-- üß† Hist√≥rico de Dicas da IA -->
<div class="card border-success mt-4">
  <div class="card-body">
    <div class="d-flex align-items-center gap-3">
      <h4 class="m-0">üß† Hist√≥rico de Dicas da IA</h4>
      <span id="badgeNovasDicas" class="badge bg-success d-none">Novas dicas: 0</span>

      <button id="btnHistoricoIA" class="btn btn-sm btn-outline-success ms-auto me-2" type="button"
              data-bs-toggle="modal" data-bs-target="#modalHistoricoIA">
        Ver Hist√≥rico
      </button>

      <button id="btnReloadDicas" class="btn btn-sm btn-outline-primary me-2" type="button">Atualizar hist√≥rico</button>
    </div>
  </div>
</div>

<!-- üîé Filtros do Hist√≥rico da IA (usando V1) -->
<div class="d-flex align-items-center gap-2 flex-wrap mb-3 mt-2">
  <div class="btn-group" role="group" aria-label="Filtros IA">
    <button
      id="btnTodas"
      class="btn btn-outline-secondary active btn-filtro"
      type="button"
      data-filtro="todas"
      data-ia-filtro="todas"
    >
      Todas (<span id="countAll">0</span>)
    </button>

    <button
      id="btnPositivas"
      class="btn btn-outline-success btn-filtro"
      type="button"
      data-filtro="positiva"
      data-ia-filtro="positiva"
    >
      Positivas (<span id="countPos">0</span>)
    </button>

    <button
      id="btnAlertas"
      class="btn btn-outline-warning btn-filtro"
      type="button"
      data-filtro="alerta"
      data-ia-filtro="alerta"
    >
      Alertas (<span id="countAlerta">0</span>)
    </button>

    <button
      id="btnNeutras"
      class="btn btn-outline-secondary btn-filtro"
      type="button"
      data-filtro="neutra"
      data-ia-filtro="neutra"
    >
      Neutras (<span id="countNeutra">0</span>)
    </button>
  </div>  
</div>

<!-- Lista principal do hist√≥rico (V1) -->
<div id="ovlHistorico" class="d-none text-center my-2">Carregando hist√≥rico‚Ä¶</div>
<div id="listaHistorico" data-feed-url="/financeiro/ia/historico/feed/v2/"></div>

<!-- A√ß√µes extras -->
<button id="btnMarcarLidas" class="btn btn-outline-dark ms-1" type="button">
  Marcar como lidas
</button>
<button id="btnExportCsv" class="btn btn-outline-success btn-sm ms-1" type="button">
  Exportar CSV
</button>


<!-- Modal -->
<div class="modal fade" id="modalHistoricoIA" tabindex="-1" aria-labelledby="modalHistoricoIALabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modalHistoricoIALabel" class="modal-title">üß† Hist√≥rico de Dicas da IA</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="listaHistoricoModal" class="list-group list-group-flush"
             data-feed-url="{% url 'financeiro:ia_historico_feed_v2' %}"></div>
        <button id="btnVerMaisHistoricoModal" class="btn btn-outline-secondary btn-sm mt-2">Ver mais</button>
      </div>
      <div class="modal-footer">
        <button id="btnReloadDicasModal" type="button" class="btn btn-outline-primary">Atualizar</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<div class="mt-3 position-relative">
  <div id="feedDicas" class="vstack gap-2"></div>
</div>
<div id="cardResumoMes" class="alert d-none mt-2"></div>

<!-- ‚¨áÔ∏è CARD DO GR√ÅFICO -->
<div class="row g-3">
  <div class="col-md-6">
    <div class="card h-100 p-3">
      <h3 class="h6 mb-2">üìà Evolu√ß√£o di√°ria</h3>
      <div class="chart-box">
        <canvas id="graficoEvolucao"></canvas>
      </div>
      <div id="evolucaoEmpty" class="sem-dados" hidden>Sem dados para o per√≠odo escolhido.</div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card h-100 p-3">
      <h3 class="h6 mb-2">üß© Por categoria</h3>
      <div class="chart-box">
        <canvas id="graficoCategorias"></canvas>
      </div>
      <div id="categoriasEmpty" class="sem-dados" hidden>Sem dados para o per√≠odo escolhido.</div>
    </div>
  </div>
</div>

<!-- üìä An√°lise 30D ‚Äî Beta Avan√ßado -->
<div class="card shadow-sm mb-3" id="cardAnalise30d">
  <div class="card-header d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-2">
      <span class="badge bg-success-subtle text-success border border-success-subtle">IA Avan√ßada</span>
      <strong>üìä An√°lise dos √öltimos 30 Dias</strong>
      <span id="a30_tipo_badge" class="ms-2" style="display:none"></span>
    </div>
    <button class="btn btn-outline-success btn-sm" id="btnReloadAnalise30d">Atualizar</button>
  </div>

  <div class="card-body">
    <div id="analise30dStatus" class="text-muted small mb-2">Carregando an√°lise‚Ä¶</div>

    <!-- KPIs -->
    <div class="row g-3" id="analise30dKPIs" style="display:none">
      <div class="col-6 col-md-3">
        <div class="border rounded p-2 h-100">
          <div class="text-muted small">Receitas (30d)</div>
          <div class="fs-5 fw-semibold" id="a30_receitas">‚Äî</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="border rounded p-2 h-100">
          <div class="text-muted small">Despesas (30d)</div>
          <div class="fs-5 fw-semibold" id="a30_despesas">‚Äî</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="border rounded p-2 h-100">
          <div class="text-muted small">Saldo (30d)</div>
          <div class="fs-5 fw-semibold" id="a30_saldo">‚Äî</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="border rounded p-2 h-100">
          <div class="text-muted small">Margem</div>
          <div class="fs-5 fw-semibold" id="a30_margem">‚Äî</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="border rounded p-2 h-100">
          <div class="text-muted small">Var. Receitas</div>
          <div class="fs-6" id="a30_var_rec">‚Äî</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="border rounded p-2 h-100">
          <div class="text-muted small">Var. Despesas</div>
          <div class="fs-6" id="a30_var_des">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Plano de a√ß√£o -->
    <div class="mt-3" id="analise30dPlanoWrap" style="display:none">
      <div id="analise30dPlano" class="p-3 rounded-3 border"></div>
    </div>
    <small class="text-muted" id="analise30dPeriodo">Per√≠odo: ‚Äî</small>
  </div>
</div>

<style>
  .loading-overlay{position:absolute;inset:0;z-index:10;background:rgba(255,255,255,.6);display:flex;align-items:center;justify-content:center}
  .fade-in{animation:fadeIn .4s ease-out}
  @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
</style>

<div id="placeholderInsights" class="mt-3">
  <h4 class="mt-4">üìà Resumo mensal da IA</h4>
  <canvas id="chartResumoIA" height="120"></canvas>
  <div id="resumoIAStats" class="mt-2 small text-muted"></div>
  <div>Insight ‚Ä¢ 12/10/2025 23:25</div>
  <div>Dica gerada em 12/10 20:25</div>
  <div>Registre receitas e despesas diariamente. Em 7 dias, voc√™ j√° enxerga padr√µes claros.</div>
</div>

<div class="d-flex align-items-center gap-2 mt-3">
  <button id="btnGerarDicaSimples" class="btn btn-success btn-sm">‚ö° Gerar Nova Dica</button>
  <span id="statusDica" class="small text-muted"></span>
</div>

<div id="cardsInsight" class="mt-3">
  {% if ultimo_insight %}
    <div data-insight-bloco class="card border-success">
      <div class="card-body">
        <div class="small text-muted">Insight ‚Ä¢ {{ ultimo_insight.created_at|date:"d/m/Y H:i" }}</div>
        <h5 class="card-title mb-1">{{ ultimo_insight.title|default:"Nova dica"|escape }}</h5>
        <p class="mb-2" style="white-space:pre-wrap">{{ ultimo_insight.text|default:"" }}</p>
        <span class="badge bg-success-subtle text-success border border-success-subtle">
          {{ ultimo_insight.get_kind_display }}
          {% if ultimo_insight.categoria_dominante %} ‚Ä¢ {{ ultimo_insight.categoria_dominante }}{% endif %}
        </span>
        {% if ultimo_insight.score %}
          <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle ms-1">
            Score: {{ ultimo_insight.score }}
          </span>
        {% else %}
          <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle ms-1">Sem score</span>
        {% endif %}
      </div>
    </div>
  {% else %}
    <div id="placeholderInsightCard" class="alert alert-secondary">
      <div class="small text-muted">Insight</div>
      <p class="mb-0">Ainda n√£o h√° dicas. Em breve vamos gerar a primeira automaticamente.</p>
    </div>
  {% endif %}
</div>

<script>
  window.URL_DADOS_GRAFICO = "{% url 'financeiro:dados_grafico_filtrados' %}";
  window.URL_RESUMO_MENSAL = "{% url 'financeiro:ia_resumo_mensal' %}";
  window.URL_CATEGORIAS   = "{% url 'financeiro:categorias_transacao' %}";
</script>
<script>
  (function () {
    const STORAGE_KEY = "sj_tema";
    const btn = document.getElementById("btnToggleTema");
    if (!btn) return;

    function aplicarTema(tema) {
      if (tema === "dark") {
        document.body.classList.add("sj-dark");
        btn.textContent = "‚òÄÔ∏è Modo claro";
        btn.classList.remove("btn-outline-dark");
        btn.classList.add("btn-outline-light");
      } else {
        document.body.classList.remove("sj-dark");
        btn.textContent = "üåô Modo escuro";
        btn.classList.remove("btn-outline-light");
        btn.classList.add("btn-outline-dark");
      }
    }

    // Carrega tema salvo
    const salvo = localStorage.getItem(STORAGE_KEY) || "light";
    aplicarTema(salvo);

    btn.addEventListener("click", (ev) => {
      if (!ev.isTrusted) return;
      const ativo = document.body.classList.contains("sj-dark");
      const proximo = ativo ? "light" : "dark";
      localStorage.setItem(STORAGE_KEY, proximo);
      aplicarTema(proximo);
    });
  })();
</script>

<!-- Ordem correta -->
<script src="{% static 'js/utils.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="{% static 'js/mini_ia.js' %}?v=20251110"></script>
<script src="{% static 'js/historico_ia.js' %}"></script>
<script src="{% static 'js/dashboard.js' %}?v=20251105"></script>

<div class="card shadow-sm mt-4 border-success-subtle" style="font-size:.9rem;">
  <div class="card-body text-center text-muted">
    <h6 class="text-success fw-bold mb-1">üêæ Spa√ßo da Jhus√©na ‚Äî Painel Financeiro Inteligente üíö</h6>
    <p class="mb-2">
      Sistema de <strong>gest√£o financeira e IA anal√≠tica</strong> em <strong>Django + Bootstrap + Chart.js</strong>.<br>
      Gera <em>dicas autom√°ticas</em>, analisa √∫ltimos 30 dias e classifica insights em
      <span class="text-success">Positivas</span>, <span class="text-warning">Alertas</span> e <span class="text-secondary">Neutras</span>.
    </p>
    <div class="d-flex justify-content-center flex-wrap gap-2 mb-2">
      <span class="badge bg-success-subtle text-success border border-success">IA Financeira</span>
      <span class="badge bg-info-subtle text-info border border-info">Dashboard Interativo</span>
      <span class="badge bg-secondary-subtle text-secondary border border-secondary">Hist√≥rico IA v2</span>
      <span class="badge bg-warning-subtle text-warning border border-warning">Modo Turbo</span>
    </div>
    <p class="mb-1"><small><strong>Desenvolvido por:</strong> J√∫lio Sena ‚Ä¢ <em>Mentoria t√©cnica ChatGPT</em></small></p>
    <p class="mb-0"><small>2025 ¬© Projeto Spa√ßo da Jhus√©na ‚Äî Todos os direitos reservados.</small></p>
  </div>
</div>

{% endblock content %}
