{% extends "base.html" %}
{% load moeda %}
{% load static %}

{% block title %}üìä Painel Financeiro{% endblock %}

{% block content %}
{% csrf_token %}
<meta name="csrf-token" content="{{ csrf_token }}" />

<p style="opacity: 0.6">
  DEBUG: {{ total_receitas }} | {{ total_despesas }} | {{ saldo }}
</p>

<h2 class="mb-3">üìä Painel Financeiro Inteligente</h2>
<div class="alert alert-success">
  Se voc√™ est√° vendo esta mensagem, o template carregou certinho. ü§ù
</div>

<div id="boxResumoMensal" class="alert alert-info d-none"></div>

<script>
  // Helpers globais j√° usados pelos seus scripts
  const MESES = ["","Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const brl = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });
  const num = (x) => (typeof x === "number" ? x : Number(x) || 0);

  function getCsrfToken() {
    const m = document.querySelector('meta[name="csrf-token"]');
    if (m && m.content) return m.content;
    const match = document.cookie.match(/(^|;)\s*csrftoken=([^;]+)/);
    return match ? decodeURIComponent(match[2]) : "";
  }

  async function carregarResumoMensal() {
    const box = document.getElementById("boxResumoMensal");
    if (!box) return;
    try {
      const url = window.URL_RESUMO_MENSAL || "/financeiro/ia/resumo-mensal/";
      const r = await fetch(url, {
        headers: { "X-Requested-With": "XMLHttpRequest" },
        credentials: "same-origin",
      });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const d = await r.json();
      const mes = Number(d.mes) || 0;
      const ano = d.ano || "";
      const mesLabel = mes >= 1 && mes <= 12 ? `${MESES[mes]}/${ano}` : `${mes}/${ano}`;

      box.classList.remove("d-none","alert-warning");
      box.classList.add("alert-info");
      box.innerHTML = `
        <strong>üìÖ ${mesLabel}</strong><br>
        Receitas: ${brl.format(num(d.total_receitas))} |
        Despesas: ${brl.format(num(d.total_despesas))} |
        Saldo: ${brl.format(num(d.saldo))}
      `;
      if (d.dica) {
        const dicaEl = document.createElement("div");
        dicaEl.textContent = `üí° ${d.dica}`;
        box.appendChild(dicaEl);
      }
      document.getElementById("placeholderInsights")?.classList.add("d-none");
      document.getElementById("placeholderInsightCard")?.classList.add("d-none");
    } catch (e) {
      box.classList.remove("d-none","alert-info");
      box.classList.add("alert-warning");
      box.textContent = "N√£o foi poss√≠vel carregar o resumo mensal agora.";
      console.error("Falha ao carregar resumo mensal:", e);
    }
  }
  document.addEventListener("DOMContentLoaded", carregarResumoMensal);
</script>

<!-- Totais -->
<div class="row g-3">
  <div class="col-md-4">
    <div class="card border-success">
      <div class="card-body">
        <div class="fw-semibold">Receitas</div>
        <div class="h4 text-success">{{ total_receitas|moeda }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-danger">
      <div class="card-body">
        <div class="fw-semibold">Despesas</div>
        <div class="h4 text-danger">{{ total_despesas|moeda }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-primary">
      <div class="card-body">
        <div class="fw-semibold">Saldo</div>
        <div class="h4 text-primary">{{ saldo|moeda }}</div>
      </div>
    </div>
  </div>
</div>

<!-- üí° Œ≤ Mini-IA -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card border-primary">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            üí° Recomenda√ß√µes Inteligentes
            <span class="badge bg-primary-subtle text-primary border border-primary ms-2">Œ≤ Mini-IA</span>
          </h5>
          <button id="btnTurbo" class="btn btn-primary btn-sm" type="button">
            ‚ö° Gerar dica dos √∫ltimos 30 dias
          </button>
        </div>

        <div id="turboStatus" class="small text-muted mt-2 d-none">Analisando‚Ä¶</div>

        <div id="turboResult" class="mt-3 d-none">
          <div class="alert alert-info mb-2" id="turboDica"></div>
          <details class="small">
            <summary>M√©tricas do per√≠odo</summary>
            <ul class="mb-0" id="turboMetrics"></ul>
          </details>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üß≠ Filtros Superiores -->
<div class="row g-2 align-items-end mb-2 mt-4">
  <div class="col-sm-3">
    <label class="form-label">In√≠cio</label>
    <input type="date" id="filtroInicio" class="form-control" />
  </div>
  <div class="col-sm-3">
    <label class="form-label">Fim</label>
    <input type="date" id="filtroFim" class="form-control" />
  </div>
  <div class="col-sm-3">
    <label for="filtroCategoria" class="form-label">Categoria</label>
    <select id="filtroCategoria" class="form-select">
      <option value="">Todas</option>
      <option value="Geral">Geral</option>
      <option value="Alerta">Alerta</option>
      <option value="Meta">Meta</option>
      <option value="Dica">Dica</option>
    </select>
  </div>
  <div class="col-sm-3 d-flex gap-2">
    <button id="btnAplicarFiltros" class="btn btn-success w-50" type="button">Aplicar</button>
    <button id="btnGerarDica" class="btn btn-outline-primary w-50" type="button">Gerar nova dica</button>
  </div>
</div>

<!-- üß† Hist√≥rico de Dicas da IA -->
<div class="d-flex align-items-center gap-3 mt-4">
  <h4 class="m-0">üß† Hist√≥rico de Dicas da IA</h4>
  <span id="badgeNovas" class="badge bg-warning text-dark d-none" title="Novas desde sua √∫ltima visita">
    Novas dicas: <span id="badgeNovasCount">0</span>
  </span>
  <button id="btnHistoricoIA"
        class="btn btn-sm btn-outline-success ms-auto me-2"
        type="button"
        data-bs-toggle="modal"
        data-bs-target="#modalHistoricoIA">
  Ver Hist√≥rico
</button>

  <button id="btnReloadDicas" class="btn btn-sm btn-outline-primary" type="button">
    Atualizar hist√≥rico
  </button>
</div>

<!-- ‚öôÔ∏è Filtros r√°pidos -->
<div class="mt-2">
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-sm btn-outline-primary active" data-filter="all">
      Todas <span class="badge bg-light text-dark ms-1" id="countAll">0</span>
    </button>
    <button type="button" class="btn btn-sm btn-outline-success" data-filter="positiva">
      Positivas <span class="badge bg-light text-dark ms-1" id="countPos">0</span>
    </button>
    <button type="button" class="btn btn-sm btn-outline-warning" data-filter="alerta">
      Alertas <span class="badge bg-light text-dark ms-1" id="countAlerta">0</span>
    </button>
    <button type="button" class="btn btn-sm btn-outline-secondary" data-filter="neutra">
      Neutras <span class="badge bg-light text-dark ms-1" id="countNeutra">0</span>
    </button>
  </div>
</div>

<!-- Preview no painel -->
<section class="mt-3">
  <div class="d-flex justify-content-between align-items-center">
    <h6 class="mb-0">üß† Hist√≥rico de Dicas da IA</h6>   
  </div>
  <!-- Novo ID para o preview -->
  <div id="listaHistorico" data-feed-url="{% url 'financeiro:ia_historico_feed' %}"></div>

</section>

<!-- Modal: Hist√≥rico de Dicas da IA -->
<div class="modal fade" id="modalHistoricoIA" tabindex="-1" 
 aria-labelledby="modalHistoricoIALabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modalHistoricoIALabel" class="modal-title">üß† Hist√≥rico de Dicas da IA</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <!-- Novo ID para o modal -->
        <div id="listaHistoricoModal" data-feed-url="{% url 'financeiro:ia_historico_feed' %}"></div>
        <button id="btnVerMais" class="btn btn-outline-secondary btn-sm mt-2">Ver mais</button>
      </div>
      <div class="modal-footer">
        <button id="btnReloadDicasModal" type="button" class="btn btn-outline-primary">Atualizar</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS (necess√°rio para modal funcionar) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<!-- üîÑ Script do hist√≥rico -->
<!-- ‚öôÔ∏è Hist√≥rico de Dicas: liga bot√µes e renderiza cards (sem historico_ia.js) -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const list = document.getElementById('listaHistorico');
  const btnAtualizar = document.getElementById('btnReloadDicas');
  const grp = document.querySelector('.btn-group[role="group"]'); // seus filtros com data-filter
  if (!list) return;

  const FEED_URL = "/financeiro/ia/historico-feed/"; // bate com urls.py
  let filtroCategoria = ""; // "" = todas

  async function carregarHistorico(limit = 20) {
    if (btnAtualizar) btnAtualizar.disabled = true;

    const qs = new URLSearchParams({ limit: String(limit) });
    // per√≠odo (se existir na p√°gina)
    const di = document.getElementById("filtroInicio")?.value || document.getElementById("data_inicio")?.value;
    const df = document.getElementById("filtroFim")?.value    || document.getElementById("data_fim")?.value;
    if (di) qs.set("inicio", di);
    if (df) qs.set("fim", df);

    if (filtroCategoria) qs.set("categoria", filtroCategoria); // neutra|positiva|alerta|geral

    let data = { items: [] };
    try {
      const r = await fetch(`${FEED_URL}?${qs}`, { headers: { Accept: "application/json" }, credentials: "same-origin" });
      if (r.ok) data = await r.json();
    } catch (e) {
      console.error("Falha ao buscar hist√≥rico:", e);
    } finally {
      if (btnAtualizar) btnAtualizar.disabled = false;
    }

    renderLista(data);
  }

  function formatQuando(it) {
    const raw = it.created_at_br || it.created_at || it.data || it.quando || it.timestamp || "";
    return raw ? String(raw) : new Date().toLocaleString("pt-BR");
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function cardHTML(it) {
    const texto = (it.text || it.texto || it.dica || it.conteudo || "").toString().trim();
    if (!texto) return ""; // ignora vazios
    const titulo = (it.title || it.titulo || (texto.split("\n")[0] || "Dica da IA")).toString();
    const catRaw = (it.categoria || it.categoria_dominante || it.tipo || it.kind || "Geral").toString();
    const cat = catRaw.charAt(0).toUpperCase() + catRaw.slice(1);

    return `
      <div class="card border-success mb-3 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="badge bg-success-subtle text-success border border-success-subtle">${escapeHtml(cat)}</span>
            <small class="text-muted">${escapeHtml(formatQuando(it))}</small>
          </div>
          <h6 class="card-title text-success mb-1">${escapeHtml(titulo)}</h6>
          <p class="card-text mb-0" style="white-space: pre-wrap">${escapeHtml(texto)}</p>
        </div>
      </div>`;
  }

  function renderLista(json) {
    const arr = (json && (json.items || json.results || json.data)) || [];
    const html = (Array.isArray(arr) ? arr : []).map(cardHTML).filter(Boolean).join("");
    list.innerHTML = html || `<div class="alert alert-secondary mb-2">Nenhuma dica encontrada.</div>`;
  }

  // Bot√£o ‚ÄúAtualizar hist√≥rico‚Äù
  if (btnAtualizar) {
    const clone = btnAtualizar.cloneNode(true);   // remove listeners antigos
    btnAtualizar.replaceWith(clone);
    clone.addEventListener("click", () => carregarHistorico(20));
  }

  // Filtros por data-filter (Todas/Positivas/Alertas/Neutras)
  if (grp) {
    const grpClone = grp.cloneNode(true);         // remove listeners antigos
    grp.replaceWith(grpClone);

    grpClone.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button[data-filter]');
      if (!btn) return;
      const f = btn.getAttribute('data-filter');  // all|positiva|alerta|neutra|geral

      // UI: marca ativo
      grpClone.querySelectorAll('button[data-filter]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      filtroCategoria = (f === 'all') ? '' : f;   // "" = todas
      carregarHistorico(20);
    });
  }

  // carrega ao abrir a p√°gina
  carregarHistorico(20);
});
</script>


<!-- üìö Feed adicional -->
<div class="mt-3 position-relative">
  <div id="ovlHistorico" class="loading-overlay d-none">
    <div class="spinner-border" role="status" aria-label="Carregando"></div>
  </div>
  <div id="feedDicas" class="vstack gap-2"></div>
</div>

<div class="mt-2">
  <button id="btnVerMaisFeed" class="btn btn-outline-secondary btn-sm" type="button">
    Ver mais
  </button>
</div>


<div class="row g-3">
  <!-- Gr√°fico de Evolu√ß√£o (linhas) -->
  <div class="col-12 col-lg-8">
    <div class="card h-100">
      <div class="card-body chart-box">
        <h5 class="card-title mb-3">Evolu√ß√£o di√°ria</h5>
        <canvas id="graficoEvolucao" style="max-height:320px;"></canvas>
        <div id="evolucaoEmpty" class="text-muted small mt-2" hidden>
          Sem dados para o per√≠odo escolhido.
        </div>
      </div>
    </div>
  </div>

  <!-- Gr√°fico de Categorias (placeholder at√© ter endpoint real) -->
  <div class="col-12 col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title mb-3">Por categoria</h5>
        <canvas id="graficoCategorias" style="max-height:320px;"></canvas>
        <div id="categoriasEmpty" class="text-muted small mt-2" hidden>
          Sem categorias neste per√≠odo.
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .loading-overlay {
    position: absolute; inset: 0; z-index: 10;
    background: rgba(255,255,255,0.6);
    display: flex; align-items: center; justify-content: center;
  }
  .fade-in { animation: fadeIn .4s ease-out; }
  @keyframes fadeIn { from { opacity:0; transform: translateY(4px);} to { opacity:1; transform:none; } }
</style>

<div id="placeholderInsights" class="mt-3">
  <h4 class="mt-4">üìà Resumo mensal da IA</h4>
  <canvas id="chartResumoIA" height="120"></canvas>
  <div id="resumoIAStats" class="mt-2 small text-muted"></div>
  <div>Insight ‚Ä¢ 12/10/2025 23:25</div>
  <div>Dica gerada em 12/10 20:25</div>
  <div>Registre receitas e despesas diariamente. Em 7 dias, voc√™ j√° enxerga padr√µes claros.</div>
</div>

<!-- Bot√£o Gerar Nova Dica (cart√£o do √∫ltimo insight) -->
<div class="d-flex align-items-center gap-2 mt-3">
  <button id="btnGerarDicaSimples" class="btn btn-success btn-sm">‚ö° Gerar Nova Dica</button>
  <span id="statusDica" class="small text-muted"></span>
</div>

<!-- √öltimo Insight -->
<div id="cardsInsight" class="mt-3">
  {% if ultimo_insight %}
    <div data-insight-bloco class="card border-success">
      <div class="card-body">
        <div class="small text-muted">
          Insight ‚Ä¢ {{ ultimo_insight.created_at|date:"d/m/Y H:i" }}
        </div>
        <h5 class="card-title mb-1">
          {{ ultimo_insight.title|default:"Nova dica"|escape }}
        </h5>
        <p class="mb-2" style="white-space:pre-wrap">
          {{ ultimo_insight.text|default:"" }}
        </p>

        <span class="badge bg-success-subtle text-success border border-success-subtle">
          {{ ultimo_insight.get_kind_display }}
          {% if ultimo_insight.categoria_dominante %}
            ‚Ä¢ {{ ultimo_insight.categoria_dominante }}
          {% endif %}
        </span>

        {% if ultimo_insight.score %}
          <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle ms-1">
            Score: {{ ultimo_insight.score }}
          </span>
        {% else %}
          <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle ms-1">
            Sem score
          </span>
        {% endif %}
      </div>
    </div>
  {% else %}
    <div id="placeholderInsightCard" class="alert alert-secondary">
      <div class="small text-muted">Insight</div>
      <p class="mb-0">Ainda n√£o h√° dicas. Em breve vamos gerar a primeira automaticamente.</p>
    </div>
  {% endif %}
</div>

<style>
  #graficoEvolucao, #graficoCategorias { height: 320px !important; }
</style>


<!-- URLs globais usadas pelos scripts -->
<script>
  window.URL_DADOS_GRAFICO = "{% url 'financeiro:dados_grafico_filtrados' %}";
  window.URL_RESUMO_MENSAL = "{% url 'financeiro:ia_resumo_mensal' %}";
  window.URL_CATEGORIAS = null;

  // Opcional: quando tiver endpoint real de categorias, setar aqui.
  // window.URL_CATEGORIAS = "{% url 'financeiro:metrics_despesas_por_categoria' %}";
</script>

<!-- Ordem: Chart.js -> dashboard.js -> seus scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="{% static 'financeiro/historico_ia.js' %}?v=1"></script>
<script src="{% static 'js/dashboard.js' %}"></script>


<!-- Seus scripts j√° existentes (Mini-IA, feed, etc.) permanecem aqui SEM a l√≥gica de gr√°ficos -->
<!-- (deixei como estavam; n√£o repito aqui para n√£o alongar mais) -->
 

{% endblock %}
