{% extends "base.html" %}
{% load moeda %}
{% load static %}

{% block title %}üìä Painel Financeiro{% endblock %}

{% block content %}
{% csrf_token %}
<meta name="csrf-token" content="{{ csrf_token }}" />

<p style="opacity:.6">DEBUG: {{ total_receitas }} | {{ total_despesas }} | {{ saldo }}</p>

<h2 class="mb-3">üìä Painel Financeiro Inteligente</h2>
<div class="alert alert-success">Se voc√™ est√° vendo esta mensagem, o template carregou certinho. ü§ù</div>

<div id="boxResumoMensal" class="alert alert-info d-none"></div>
<script>
async function carregarResumoMensal() {
  const r = await fetch("/financeiro/ia/resumo-mensal/");
  const d = await r.json();
  const box = document.getElementById("boxResumoMensal");
  box.classList.remove("d-none");
}
  // Formata√ß√£o BRL no front

(function () {
  const brl = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

  async function carregarResumoMensal() {
    try {
    const r = await fetch("/financeiro/ia/resumo-mensal/");
      const d = await r.json();

      const box = document.getElementById("boxResumoMensal");
      box.classList.remove("d-none");
      box.innerHTML = `
        <strong>üìÖ ${d.mes}</strong><br>
        Receitas: ${brl.format(d.receitas)} | Despesas: ${brl.format(d.despesas)} | Saldo: ${brl.format(d.saldo)}<br>
        üí° ${d.dica}
      `;

      // Esconde o placeholder antigo, se existir
      const ph = document.getElementById("placeholderInsights");
      if (ph) ph.classList.add("d-none");
    } catch (e) {
      console.error("Falha ao carregar resumo mensal:", e);
    }
  }

  carregarResumoMensal();
})();
</script>

<!-- Totais -->
<div class="row g-3">
  <div class="col-md-4">
    <div class="card border-success"><div class="card-body">
      <div class="fw-semibold">Receitas</div>
      <div class="h4 text-success">{{ total_receitas|moeda }}</div>
    </div></div>
  </div>
  <div class="col-md-4">
    <div class="card border-danger"><div class="card-body">
      <div class="fw-semibold">Despesas</div>
      <div class="h4 text-danger">{{ total_despesas|moeda }}</div>
    </div></div>
  </div>
  <div class="col-md-4">
    <div class="card border-primary"><div class="card-body">
      <div class="fw-semibold">Saldo</div>
      <div class="h4 text-primary">{{ saldo|moeda }}</div>
    </div></div>
  </div>
</div>

<!-- Œ≤ Mini-IA -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card border-primary">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            üí° Recomenda√ß√µes Inteligentes
            <span class="badge bg-primary-subtle text-primary border border-primary ms-2">Œ≤ Mini-IA</span>
          </h5>
          <button id="btnTurbo" class="btn btn-primary btn-sm">‚ö° Gerar dica dos √∫ltimos 30 dias</button>
        </div>

        <div id="turboStatus" class="small text-muted mt-2 d-none">Analisando‚Ä¶</div>
        <div id="turboResult" class="mt-3 d-none">
          <div class="alert alert-info mb-2" id="turboDica"></div>
          <details class="small">
            <summary>M√©tricas do per√≠odo</summary>
            <ul class="mb-0" id="turboMetrics"></ul>
          </details>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üß† Hist√≥rico de Dicas da IA -->
<div class="d-flex align-items-center gap-3 mt-4">
  <h4 class="m-0">üß† Hist√≥rico de Dicas da IA</h4>
  <span id="badgeNovas" class="badge bg-warning text-dark d-none" title="Novas desde sua √∫ltima visita">
    Novas dicas: <span id="badgeNovasCount">0</span>
  </span>
  <button id="btnReloadDicas" class="btn btn-sm btn-outline-primary ms-auto" type="button">
    Atualizar hist√≥rico
  </button>
</div>

<!-- Filtros -->
<div class="mt-2">
  <div class="btn-group" role="group">
    <button class="btn btn-sm btn-outline-primary active" data-filter="all">
      Todas <span class="badge bg-light text-dark ms-1" id="countAll">0</span>
    </button>
    <button class="btn btn-sm btn-outline-success" data-filter="positiva">
      Positivas <span class="badge bg-light text-dark ms-1" id="countPos">0</span>
    </button>
    <button class="btn btn-sm btn-outline-warning" data-filter="alerta">
      Alertas <span class="badge bg-light text-dark ms-1" id="countAlerta">0</span>
    </button>
    <button class="btn btn-sm btn-outline-secondary" data-filter="neutra">
      Neutras <span class="badge bg-light text-dark ms-1" id="countNeutra">0</span>
    </button>
  </div>
</div>

<!-- Feed -->
<div class="mt-3 position-relative">
  <div id="ovlHistorico" class="loading-overlay d-none">
    <div class="spinner-border" role="status" aria-label="Carregando"></div>
  </div>
  <div id="feedDicas" class="vstack gap-2"></div>
</div>
<div class="mt-2">
  <button id="btnVerMais" class="btn btn-outline-secondary btn-sm">Ver mais</button>
</div>

<style>
.loading-overlay{position:absolute;inset:0;z-index:10;background:rgba(255,255,255,.6);
display:flex;align-items:center;justify-content:center;}
.fade-in{animation:fadeIn .4s ease-out;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
</style>
<div id="placeholderInsights" class="mt-3">
<h4 class="mt-4">üìà Resumo mensal da IA</h4>
<canvas id="chartResumoIA" height="120"></canvas>
<div id="resumoIAStats" class="mt-2 small text-muted"></div>
 <div>Insight ‚Ä¢ 12/10/2025 23:25</div>
  <div>Dica gerada em 12/10 20:25</div>
  <div>Registre receitas e despesas diariamente. Em 7 dias, voc√™ j√° enxerga padr√µes claros.</div>
</div>

<!-- Bot√£o Gerar Nova Dica -->
<div class="d-flex align-items-center gap-2 mt-3">
  <button id="btnGerarDica" class="btn btn-success btn-sm">‚ö° Gerar Nova Dica</button>
  <span id="statusDica" class="small text-muted"></span>
</div>

<!-- √öltimo Insight -->
<div id="cardsInsight" class="mt-3">
  <div data-insight-bloco class="card {% if ultimo_insight %}border-success{% else %}border-secondary{% endif %}">
    <div class="card-body">
      {% if ultimo_insight %}
        <div class="small text-muted">Insight ‚Ä¢ {{ ultimo_insight.created_at|date:"d/m/Y H:i" }}</div>
        <h5 class="card-title mb-1">{{ ultimo_insight.title }}</h5>
        <p class="mb-2">{{ ultimo_insight.text }}</p>
        <span class="badge bg-success-subtle text-success border border-success-subtle">
          {{ ultimo_insight.get_kind_display }}
          {% if ultimo_insight.categoria_dominante %} ‚Ä¢ {{ ultimo_insight.categoria_dominante }}{% endif %}
        </span>
        {% if ultimo_insight.score %}
        <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle ms-1">
          Score: {{ ultimo_insight.score }}
        </span>{% endif %}
      {% else %}
      <div id="placeholderInsights">
        <div class="small text-muted">Insight</div>
        <p class="mb-0">Ainda n√£o h√° dicas. Em breve vamos gerar a primeira automaticamente.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'financeiro/historico_ia.js' %}"></script>

<!-- Feed √önico (Hist√≥rico de Dicas) -->
<script>
document.addEventListener('DOMContentLoaded', ()=> {
  const urlFeed = "{% url 'financeiro:ia_historico_feed' %}";
  let pageSize = 10;

  function renderItem(i){
    const dt = (i.created_at_br || i.created_at || '').replace('T',' ').slice(0,16);
    const t  = i.title || 'Dica da IA';
    const tx = i.text || i.texto || '';
    const k  = (i.kind || i.categoria || 'neutra').toLowerCase();
    const cor = k==='positiva'?'success':k==='alerta'?'warning':'secondary';
    return `<div class="card mb-2 dica-item" data-kind="${k}">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <h6 class="mb-1">${t}</h6>${dt?`<small class="text-muted">Criada em: ${dt}</small>`:''}
        </div>
        <span class="badge bg-${cor} text-uppercase mb-1">${i.categoria || i.kind || 'Geral'}</span>
        <p class="mb-0">${tx}</p>
      </div>
    </div>`;
  }

  async function carregarFeed(limit = pageSize){
    const el = document.getElementById('feedDicas');
    try{
      const resp = await fetch(`${urlFeed}?limit=${Math.max(limit, 20)}`, { headers:{'X-Requested-With':'XMLHttpRequest'}});
      const data = await resp.json();
      const lista = data.items || [];

      // 1) dedup por (texto+categoria) para esconder dicas id√™nticas
      const seen = new Set();
      const dedup = [];
      for (const it of lista){
        const msg = (it.text || it.texto || '').trim();
        const cat = (it.categoria || it.kind || '').toLowerCase();
        const key = `${msg}::${cat}`;
        if (!msg || seen.has(key)) continue;
        seen.add(key);
        dedup.push(it);
      }

      // 2) limita a exibi√ß√£o a 'limit'
      const visiveis = dedup.slice(0, limit);
      el.innerHTML = visiveis.length
        ? visiveis.map(renderItem).join('')
        : `<p class="text-muted mb-0">Nenhum item ainda.</p>`;

      // contadores
      const total = dedup.length;
      const pos    = dedup.filter(i => (i.kind||'').toLowerCase()==='positiva').length;
      const alerta = dedup.filter(i => (i.kind||'').toLowerCase()==='alerta').length;
      const neutra = dedup.filter(i => (i.kind||'').toLowerCase()==='neutra').length;
      const set = (id,v)=>{ const e=document.getElementById(id); if(e) e.textContent=v; };
      set('countAll', total); set('countPos', pos); set('countAlerta', alerta); set('countNeutra', neutra);

      // controla bot√£o "Ver mais"
      const btn = document.getElementById('btnVerMais');
      if (btn) btn.style.display = total > visiveis.length ? '' : 'none';
    }catch(e){
      console.error(e);
      el.innerHTML = `<div class="alert alert-danger">Erro ao carregar feed.</div>`;
    }
  }

  // handlers
  document.getElementById('btnReloadDicas')?.addEventListener('click', ()=>carregarFeed(pageSize));
  document.querySelectorAll('[data-filter]').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('[data-filter]').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const f=b.dataset.filter;
      document.querySelectorAll('.dica-item').forEach(c=>{
        const k=c.dataset.kind;
        c.style.display = (f==='all'||f===k)?'':'none';
      });
    });
  });
  document.getElementById('btnVerMais')?.addEventListener('click', ()=>{
    pageSize += 10;
    carregarFeed(pageSize);
  });

  carregarFeed(pageSize);
});
</script>

<!-- Œ≤ Mini-IA -->
<script>
(function(){
  const b=document.getElementById('btnTurbo'),s=document.getElementById('turboStatus'),
  bx=document.getElementById('turboResult'),d=document.getElementById('turboDica'),
 m=document.getElementById('turboMetrics');
  function csrf(){return document.querySelector('meta[name="csrf-token"]')?.content||'';}
  if(b)b.onclick=async()=>{
    b.disabled=true;s.classList.remove('d-none');bx.classList.add('d-none');d.textContent='';m.innerHTML='';
    try{const r=await fetch("{% url 'financeiro:gerar_dica_30d' %}",{method:'POST',headers:{'X-CSRFToken':csrf(),'X-Requested-With':'XMLHttpRequest'}});
      const data=await r.json();if(data.ok){d.innerHTML=data.dica||'';const x=data.metrics||{};m.innerHTML=[
        `<li><strong>Per√≠odo:</strong> ${x.periodo?.inicio||''} a ${x.periodo?.fim||''}</li>`,
        `<li><strong>Total Receitas:</strong> R$ ${Number(x.total_receitas||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</li>`,
        `<li><strong>Total Despesas:</strong> R$ ${Number(x.total_despesas||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</li>`,
        `<li><strong>Saldo:</strong> R$ ${Number(x.saldo||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</li>`,
        `<li><strong>Top Categoria:</strong> ${x.top_categoria||''} ‚Äî R$ ${Number(x.top_categoria_total||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</li>`
      ].join('');bx.classList.remove('d-none');}
      else{d.textContent='N√£o foi poss√≠vel gerar a dica.';bx.classList.remove('d-none');}}
    catch(e){d.textContent='Erro ao gerar dica.';bx.classList.remove('d-none');console.error(e);}
    finally{s.classList.add('d-none');b.disabled=false;}
  };
})();
</script>

<!-- Gerar Nova Dica (Simples) -->
<script>
(function(){
 const b=document.getElementById('btnGerarDica'),st=document.getElementById('statusDica');
 function csrf(){return document.querySelector('meta[name="csrf-token"]')?.content||'';}
 if(b)b.onclick=async()=>{
   b.disabled=true;st.textContent='Gerando...';
   try{const r=await fetch("{% url 'financeiro:api_criar_insight_simples' %}",{method:'POST',headers:{'X-CSRFToken':csrf(),'X-Requested-With':'XMLHttpRequest'}});
     const j=await r.json();if(j.ok){const html=`<div data-insight-bloco class="card border-success mt-3"><div class="card-body"><div class="small text-muted">Insight ‚Ä¢ ${j.created_at}</div><h5>${j.title}</h5><p>${j.text}</p></div></div>`;
       const ib=document.querySelector('[data-insight-bloco]');if(ib)ib.outerHTML=html;else document.getElementById('cardsInsight').insertAdjacentHTML('beforeend',html);
       st.textContent='Pronto!';}else st.textContent='N√£o consegui gerar a dica.';
   }catch(e){st.textContent='Erro.';console.error(e);}
   finally{setTimeout(()=>st.textContent='',2000);b.disabled=false;}
 };
})();
</script>
{% endblock %}
