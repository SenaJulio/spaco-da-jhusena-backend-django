{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
  <h2 class="text-success mb-4">ğŸ“Š Dashboard de Agendamentos ğŸ’šğŸ¶</h2>

  <!-- CartÃµes de estatÃ­sticas -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm border-success">
        <div class="card-body text-center">
          <h5 class="card-title">Total de Agendamentos</h5>
          <p id="total-agendamentos" class="fs-4 fw-bold text-success">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm border-primary">
        <div class="card-body text-center">
          <h5 class="card-title">ConcluÃ­dos</h5>
          <p id="concluidos-percentual" class="fs-4 fw-bold text-primary">0.0%</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm border-danger">
        <div class="card-body text-center">
          <h5 class="card-title">Cancelados</h5>
          <p id="cancelados-percentual" class="fs-4 fw-bold text-danger">0.0%</p>
        </div>
      </div>
    </div>
  </div>

  <!-- GrÃ¡fico de status -->
  <div class="mb-4">
    <h4>Status dos Agendamentos</h4>
    <canvas id="statusChart" width="400" height="200"></canvas>
  </div>

  <!-- Filtro de datas e grÃ¡fico mensal -->
  <div class="mb-3">
    <h4>EvoluÃ§Ã£o Mensal</h4>
    <form class="row g-2 align-items-end mb-3" onsubmit="event.preventDefault(); filtrarDados();">
      <div class="col-sm-4">
        <label for="data_inicio" class="form-label">InÃ­cio:</label>
        <input type="date" id="data_inicio" name="data_inicio" class="form-control">
      </div>
      <div class="col-sm-4">
        <label for="data_fim" class="form-label">Fim:</label>
        <input type="date" id="data_fim" name="data_fim" class="form-control">
      </div>
      <div class="col-sm-4">
        <button type="submit" class="btn btn-success w-100">ğŸ” Filtrar</button>
      </div>
    </form>

    <canvas id="mesChart" height="200"></canvas>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <!-- Chart.js (padronizado com o financeiro) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <script>
    let mesChart;
    function updateChart(evolucao) {
      const labels = evolucao.map(item => item.mes);
      const data = evolucao.map(item => Number(item.total) || 0);

      if (mesChart) {
        mesChart.data.labels = labels;
        mesChart.data.datasets[0].data = data;
        mesChart.update();
      } else {
        const ctx = document.getElementById('mesChart')?.getContext('2d');
        if (!ctx) return;
        mesChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Agendamentos por MÃªs',
              data,
              borderColor: 'green',
              backgroundColor: 'rgba(0,128,0,0.1)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
          }
        });
      }
    }

    let statusChart;
    function updateStatusChart(contagem) {
      const normalize = (s) => String(s || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
      const labels = contagem.map(item => normalize(item.status));
      const data = contagem.map(item => Number(item.total) || 0);

      const cores = {
        agendado: '#4caf50',
        pendente: '#ff9800',
        concluido: '#2196f3',
        cancelado: '#f44336',
        outro: '#9e9e9e'
      };
      const backgroundColors = labels.map(status => cores[status] || cores.outro);

      if (statusChart) {
        statusChart.data.labels = labels;
        statusChart.data.datasets[0].data = data;
        statusChart.data.datasets[0].backgroundColor = backgroundColors;
        statusChart.update();
      } else {
        const ctx = document.getElementById('statusChart')?.getContext('2d');
        if (!ctx) return;
        statusChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{ data, backgroundColor: backgroundColors }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              title: { display: true, text: 'DistribuiÃ§Ã£o de Status' }
            }
          }
        });
      }
    }

    function filtrarDados() {
      const inicio = document.getElementById('data_inicio')?.value || '';
      const fim = document.getElementById('data_fim')?.value || '';

      const url = new URL('/agendamentos/dashboard/dados/', location.origin);
      if (inicio) url.searchParams.set('data_inicio', inicio);
      if (fim) url.searchParams.set('data_fim', fim);

      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
        .then(res => res.json())
        .then(data => {
          let total = 0, concluido = 0, cancelado = 0;
          (data.contagem_status || []).forEach(item => {
            const st = String(item.status || '').toLowerCase();
            total += Number(item.total) || 0;
            if (st === 'concluido' || st === 'concluÃ­dos') concluido = Number(item.total) || 0;
            if (st === 'cancelado' || st === 'cancelados') cancelado = Number(item.total) || 0;
          });

          const percent = val => total > 0 ? (val / total * 100).toFixed(1) + '%' : '0.0%';
          document.getElementById('total-agendamentos').textContent = total;
          document.getElementById('concluidos-percentual').textContent = percent(concluido);
          document.getElementById('cancelados-percentual').textContent = percent(cancelado);

          updateStatusChart(data.contagem_status || []);
          updateChart(data.evolucao_mensal || []);
        })
        .catch(error => console.error('Erro ao buscar dados:', error));
    }

    document.addEventListener('DOMContentLoaded', filtrarDados);
  </script>
{% endblock %}
