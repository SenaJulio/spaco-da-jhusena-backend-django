{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
  .chart-box { position: relative; width: 100%; }
  .chart-donut { height: 280px; max-width: 420px; margin: 0 auto; }
  .chart-line { height: 260px; }
  canvas { width: 100% !important; height: 100% !important; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- âœ… Topbar vendÃ¡vel (tÃ­tulo + botÃ£o inÃ­cio) -->
  <div class="d-flex justify-content-between align-items-center gap-2 mb-3">
    <h2 class="text-success m-0">ğŸ“Š Dashboard de Agendamentos ğŸ’šğŸ¶</h2>

    
  <!-- CartÃµes de estatÃ­sticas -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm border-success">
        <div class="card-body text-center">
          <h5 class="card-title">Total de Agendamentos</h5>
          <p id="total-agendamentos" class="fs-4 fw-bold text-success">0</p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm border-primary">
        <div class="card-body text-center">
          <h5 class="card-title">ConcluÃ­dos</h5>
          <p id="concluidos-percentual" class="fs-4 fw-bold text-primary">0.0%</p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm border-danger">
        <div class="card-body text-center">
          <h5 class="card-title">Cancelados</h5>
          <p id="cancelados-percentual" class="fs-4 fw-bold text-danger">0.0%</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Agendamentos de hoje -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                  ğŸ“… Agendamentos de hoje
                  <span id="badgeHojeCount" class="badge bg-success-subtle text-success border border-success-subtle ms-2">0</span>
            </h5>
            <div class="btn-group btn-group-sm mt-2" id="filtrosHoje">
              <button class="btn btn-outline-success active" data-filtro="todos">Todos</button>
              <button class="btn btn-outline-warning" data-filtro="pendentes">Pendentes</button>
              <button class="btn btn-outline-primary" data-filtro="finalizados">Finalizados</button>
            </div>
            <button id="btnRecarregarHoje" class="btn btn-sm btn-outline-success">Atualizar</button>
          </div>
          <div id="boxHoje" class="mt-3 small text-muted">Carregando...</div>
        </div>
      </div>

  <!-- GrÃ¡fico de status -->
  <div class="mb-4">
    <h4>Status dos Agendamentos</h4>
    <div class="chart-box chart-donut">
      <canvas id="statusChart"></canvas>
    </div>
  </div>

  <!-- Filtro de datas e grÃ¡fico mensal -->
  <div class="mb-3">
    <h4>EvoluÃ§Ã£o Mensal</h4>

    <form id="filtroForm" class="row g-2 align-items-end mb-3">
      <div class="col-sm-4">
        <label for="data_inicio" class="form-label">InÃ­cio:</label>
        <input type="date" id="data_inicio" name="data_inicio" class="form-control">
      </div>

      <div class="col-sm-4">
        <label for="data_fim" class="form-label">Fim:</label>
        <input type="date" id="data_fim" name="data_fim" class="form-control">
      </div>

      <div class="col-sm-4">
        <button type="submit" class="btn btn-success w-100">ğŸ” Filtrar</button>
      </div>
    </form>

    <div class="chart-box chart-line">
      <canvas id="mesChart"></canvas>
    </div>
  </div>
</div>
{% endblock %}

{% block extrabody %}

<script src="{% static 'vendor/chartjs/chart.umd.min.js' %}"></script>


<script>
  /* global Chart */

  // -----------------------
  // Helpers
  // -----------------------
  let filtroHojeAtivo = "todos";

  function fetchJson(url, options = {}) {
    return fetch(url, {
      credentials: "same-origin",
      ...options,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "Accept": "application/json",
        ...(options.headers || {}),
      },
    }).then(async (resp) => {
      const ct = resp.headers.get("content-type") || "";
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      if (!ct.includes("application/json")) {
        const txt = await resp.text();
        throw new Error("API nÃ£o retornou JSON. Recebi: " + txt.slice(0, 120));
      }
      return resp.json();
    });
  }

  function getCsrfToken() {
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : "";
  }

  function percent(val, total) {
    return total > 0 ? (val / total * 100).toFixed(1) + "%" : "0.0%";
  }

  // -----------------------
  // Charts (mantÃ©m instÃ¢ncias)
  // -----------------------
  let mesChart = null;
  let statusChart = null;

  function updateChart(evolucao) {
    const labels = (evolucao || []).map((item) => item.mes);
    const data = (evolucao || []).map((item) => Number(item.total) || 0);

    const canvas = document.getElementById("mesChart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");

    if (mesChart) {
      mesChart.data.labels = labels;
      mesChart.data.datasets[0].data = data;
      mesChart.update("none");
      return;
    }

    mesChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Agendamentos por MÃªs",
            data,
            borderColor: "green",
            backgroundColor: "rgba(0,128,0,0.1)",
            fill: true,
            tension: 0.3,
          },
        ],
      },
      options: {
        animation: false,
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
      },
    });
  }

  function updateStatusChart(contagem) {
    const labels = (contagem || []).map((item) =>
      String(item.status || "").toLowerCase()
    );
    const data = (contagem || []).map((item) => Number(item.total) || 0);

    const cores = {
      agendado: "#4caf50",
      pendente: "#ff9800",
      concluido: "#2196f3",
      cancelado: "#f44336",
      outro: "#9e9e9e",
    };

    const backgroundColors = labels.map((status) => cores[status] || cores.outro);

    const canvas = document.getElementById("statusChart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");

    if (statusChart) {
      statusChart.data.labels = labels;
      statusChart.data.datasets[0].data = data;
      statusChart.data.datasets[0].backgroundColor = backgroundColors;
      statusChart.update("none");
      return;
    }

    statusChart = new Chart(ctx, {
      type: "doughnut",
      data: { labels, datasets: [{ data, backgroundColor: backgroundColors }] },
      options: {
        animation: false,
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom" },
          title: { display: true, text: "DistribuiÃ§Ã£o de Status" },
        },
      },
    });
  }

  // -----------------------
  // Dashboard (cards + charts)
  // -----------------------
  function filtrarDados() {
    const inicio = document.getElementById("data_inicio")?.value || "";
    const fim = document.getElementById("data_fim")?.value || "";

    const url = new URL("/agendamentos/dashboard/dados/", location.origin);
    if (inicio) url.searchParams.set("data_inicio", inicio);
    if (fim) url.searchParams.set("data_fim", fim);

    fetchJson(url.toString())
      .then((data) => {
        let total = 0,
          concluido = 0,
          cancelado = 0;

        (data.contagem_status || []).forEach((item) => {
          const st = String(item.status || "").toLowerCase();
          const qtd = Number(item.total) || 0;
          total += qtd;
          if (st === "concluido") concluido = qtd;
          if (st === "cancelado") cancelado = qtd;
        });

        const elTotal = document.getElementById("total-agendamentos");
        const elConc = document.getElementById("concluidos-percentual");
        const elCanc = document.getElementById("cancelados-percentual");

        if (elTotal) elTotal.textContent = String(total);
        if (elConc) elConc.textContent = percent(concluido, total);
        if (elCanc) elCanc.textContent = percent(cancelado, total);

        updateStatusChart(data.contagem_status || []);
        updateChart(data.evolucao_mensal || []);
      })
      .catch((err) => console.error("Erro ao buscar dados do dashboard:", err));
  }

  // -----------------------
  // Hoje (render + aÃ§Ãµes)
  // -----------------------
  function renderHoje(itens) {
  const box = document.getElementById("boxHoje");
  if (!box) return;

  const badgeCount = document.getElementById("badgeHojeCount");
  const arr = Array.isArray(itens) ? itens : [];
  const totalHoje = arr.length;

  const pendentesHoje = arr.filter(a => {
    const st = String(a.status || "agendado").toLowerCase();
    return (st === "agendado" || st === "pendente");
  }).length;

  if (badgeCount) {
    badgeCount.textContent = `${totalHoje} (${pendentesHoje} pend.)`;
  }

  if (!arr.length) {
    box.innerHTML = "<div class='text-muted'>Nenhum agendamento para hoje. ğŸ‰</div>";
    return;
  }

  // âœ… Ordena por hora (HH:MM)
  const ordenados = [...arr].sort((a, b) =>
    String(a.hora || "").localeCompare(String(b.hora || ""))
  );

  // âœ… aplica filtro (mantendo item finalizado/cancelado se escolhido)
  let filtrados = ordenados;

  if (filtroHojeAtivo === "pendentes") {
    filtrados = ordenados.filter(a => {
      const st = String(a.status || "agendado").toLowerCase();
      return st === "agendado" || st === "pendente";
    });
  } else if (filtroHojeAtivo === "finalizados") {
    filtrados = ordenados.filter(a => {
      const st = String(a.status || "agendado").toLowerCase();
      return st === "concluido" || st === "cancelado";
    });
  }

  // se o filtro deixar vazio, mostra mensagem (mas mantÃ©m contador do dia lÃ¡ em cima)
  if (!filtrados.length) {
    const msg =
      filtroHojeAtivo === "pendentes"
        ? "Nenhum agendamento pendente hoje. ğŸ‰"
        : "Nenhum agendamento finalizado hoje ainda.";
    box.innerHTML = `<div class='text-muted'>${msg}</div>`;
    return;
  }

  // âœ… Badges com Ã­cone + cor
  const badgeMap = {
    agendado: `<span class="badge bg-success-subtle text-success border border-success-subtle">ğŸŸ¢ Agendado</span>`,
    pendente: `<span class="badge bg-warning-subtle text-warning border border-warning-subtle">ğŸŸ  Pendente</span>`,
    concluido: `<span class="badge bg-primary-subtle text-primary border border-primary-subtle">ğŸ”µ ConcluÃ­do</span>`,
    cancelado: `<span class="badge bg-danger-subtle text-danger border border-danger-subtle">ğŸ”´ Cancelado</span>`,
  };

  box.innerHTML = filtrados.map((a) => {
    const st = String(a.status || "agendado").toLowerCase();
    const badge = badgeMap[st] || `<span class="badge bg-secondary-subtle text-secondary border">âšª Status</span>`;

    const acoes =
      st === "agendado" || st === "pendente"
        ? `
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary js-acao"
                    data-id="${a.id}" data-acao="concluir">
              Concluir
            </button>
            <button class="btn btn-sm btn-outline-danger js-acao"
                    data-id="${a.id}" data-acao="cancelar">
              Cancelar
            </button>
          </div>
        `
        : `
          <div class="text-muted small">
            ${st === "concluido" ? "âœ” Finalizado" : "âœ– Cancelado"}
          </div>
        `;

    return `
      <div class="d-flex justify-content-between align-items-center ag-row ag-status-${st}"
           id="ag-item-${a.id}">
        <div>
          <div class="d-flex align-items-center gap-2">
            <strong>${a.hora || "--:--"}</strong>
            ${badge}
          </div>

          <div>
            ${a.pet_nome || "(sem pet)"} <span class="text-muted">(${a.servico || "-"})</span>
          </div>

          <div class="text-muted">Tutor: ${a.nome || "-"}</div>
        </div>

        ${acoes}
      </div>
    `;
  }).join("");
}



  function carregarHoje() {
    const box = document.getElementById("boxHoje");
    if (box) box.innerHTML = "<div class='text-muted'>Carregando...</div>";

    fetchJson("/agendamentos/dashboard/hoje/")
      .then((data) => {
        renderHoje(data.itens || []);
      })
      .catch((err) => {
        console.error("Erro hoje:", err);
        const box2 = document.getElementById("boxHoje");
        if (box2)
          box2.innerHTML =
            "<div class='text-danger'>Erro ao carregar agendamentos de hoje.</div>";
      });
  }

  function acaoAgendamento(id, acao) {
    // âœ… CONFIRMAÃ‡ÃƒO SOMENTE PARA CANCELAR
      if (acao === "cancelar") {
        const ok = confirm("Tem certeza que deseja cancelar este agendamento?");
        if (!ok) return; // se clicar em Cancelar, nÃ£o faz nada
      }
    const row = document.getElementById(`ag-item-${id}`);

    // trava os botÃµes do item enquanto processa
    if (row) {
      row.querySelectorAll("button").forEach((b) => (b.disabled = true));
      row.style.opacity = "0.6";
    }

    fetchJson(`/agendamentos/acao/${id}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCsrfToken(),
      },
      body: JSON.stringify({ acao }),
    })
      .then((data) => {
        if (!data.ok) throw new Error(data.erro || "Falha");

        // remove o item com animaÃ§Ã£o leve
        if (row) {
          row.style.transition = "all .18s ease";
          row.style.transform = "translateX(8px)";
          row.style.opacity = "0";
          setTimeout(() => {
            row.remove();

            // se ficou vazio, mostra msg bonita
            const box = document.getElementById("boxHoje");
            if (box && box.querySelectorAll("[id^='ag-item-']").length === 0) {
              box.innerHTML = "<div class='text-muted'>Nenhum agendamento para hoje. ğŸ‰</div>";
            }
          }, 180);
        }

        // atualiza cards e grÃ¡ficos
        filtrarDados();
      })
      .catch((err) => {
        if (row) {
          row.querySelectorAll("button").forEach((b) => (b.disabled = false));
          row.style.opacity = "1";
          row.style.transform = "";
        }
        // tenta extrair mensagem do backend (JSON) quando for HTTP 400/403/500 etc
(async () => {
  try {
    // se fetchJson lanÃ§ou "HTTP 400", buscamos a resposta real pra pegar o erro
    const resp = await fetch(`/agendamentos/acao/${id}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCsrfToken(),
      },
      body: JSON.stringify({ acao }),
      credentials: "same-origin",
    });

    let msg = err.message || "Falha";
    try {
      const j = await resp.json();
      if (j && j.erro) msg = j.erro;
    } catch (_) {}

    alert("Erro: " + msg);
  } catch (_) {
    alert("Erro: " + (err.message || "Falha"));
  }
})();

      });
  }

  // DelegaÃ§Ã£o de clique para aÃ§Ãµes
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".js-acao");
    if (!btn) return;
    const id = btn.dataset.id;
    const acao = btn.dataset.acao;
    if (!id || !acao) return;
    acaoAgendamento(id, acao);
  });

  // -----------------------
  // Boot
  // -----------------------
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("filtroForm");
    if (form)
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        filtrarDados();
      });

    const btn = document.getElementById("btnRecarregarHoje");
    if (btn) btn.addEventListener("click", carregarHoje);

    carregarHoje();
    filtrarDados();
    document.querySelectorAll("#filtrosHoje button").forEach(btn => {
    btn.addEventListener("click", () => {
    document.querySelectorAll("#filtrosHoje button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    filtroHojeAtivo = btn.dataset.filtro || "todos";
    carregarHoje(); // recarrega respeitando o filtro
  });
});
});
</script>

{% endblock %}
